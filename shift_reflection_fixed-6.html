<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shift Reflection</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD700">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Спикизи">
  
  <!-- Fallback icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue:wght@400&family=Roboto+Condensed:wght@400;700&display=swap');
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto Condensed', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #2C3E50 0%, #34495E 25%, #5D6D7E 75%, #85929E 100%);
      position: relative;
      overflow-x: hidden;
    }
    
    /* Soviet-style geometric background elements */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(220, 20, 60, 0.1) 0%, transparent 50%),
        linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.05) 30%, rgba(255, 215, 0, 0.05) 70%, transparent 70%),
        linear-gradient(-45deg, transparent 30%, rgba(220, 20, 60, 0.05) 30%, rgba(220, 20, 60, 0.05) 70%, transparent 70%);
      z-index: 1;
    }
    
    /* Animated geometric shapes */
    .bg-shapes {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 2;
      pointer-events: none;
      overflow: hidden;
    }
    
    .shape {
      position: absolute;
      opacity: 0.1;
      animation: float 20s infinite linear;
    }
    
    .shape-1 {
      width: 0;
      height: 0;
      border-left: 50px solid transparent;
      border-right: 50px solid transparent;
      border-bottom: 80px solid #FFD700;
      top: 10%;
      left: 5%;
      animation-duration: 25s;
    }
    
    .shape-2 {
      width: 60px;
      height: 60px;
      background: #DC143C;
      transform: rotate(45deg);
      top: 60%;
      right: 10%;
      animation-duration: 30s;
      animation-direction: reverse;
    }
    
    .shape-3 {
      width: 0;
      height: 0;
      border-top: 40px solid #FFD700;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      top: 80%;
      left: 15%;
      animation-duration: 35s;
    }
    
    .shape-4 {
      width: 80px;
      height: 20px;
      background: linear-gradient(90deg, #DC143C, #FFD700);
      top: 20%;
      right: 20%;
      animation-duration: 28s;
    }
    
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-20px) rotate(90deg); }
      50% { transform: translateY(0) rotate(180deg); }
      75% { transform: translateY(-10px) rotate(270deg); }
      100% { transform: translateY(0) rotate(360deg); }
    }
    
    .overlay {
      background: 
        radial-gradient(ellipse at center, rgba(44, 62, 80, 0.6) 0%, rgba(44, 62, 80, 0.8) 100%),
        linear-gradient(45deg, rgba(93, 173, 226, 0.1) 0%, rgba(133, 193, 233, 0.1) 100%);
      min-height: 100vh;
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 10;
    }
    
    .container {
      background: 
        linear-gradient(135deg, 
          rgba(52, 73, 94, 0.92) 0%, 
          rgba(44, 62, 80, 0.95) 50%, 
          rgba(93, 109, 126, 0.92) 100%
        );
      backdrop-filter: blur(10px);
      border: 2px solid #AED6F1;
      box-shadow: 
        0 0 20px rgba(174, 214, 241, 0.2),
        inset 0 0 15px rgba(174, 214, 241, 0.05);
      padding: 2.5rem;
      max-width: 650px;
      width: 100%;
      border-radius: 0;
      position: relative;
      animation: fadeIn 1s ease-in;
      color: #FFF;
    }
    
    .container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #AED6F1, #5DADE2, #AED6F1, #5DADE2);
      border-radius: 0;
      z-index: -1;
      animation: borderGlow 4s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    /* Cyrillic Graphics */
    .cyrillic-text {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .cyrillic-main {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.2rem;
      color: #D5DBDB;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 
        2px 2px 4px rgba(0, 0, 0, 0.8),
        0 0 15px rgba(213, 219, 219, 0.3);
      margin-bottom: 0.5rem;
      position: relative;
    }
    
    .cyrillic-main::before,
    .cyrillic-main::after {
      content: '▬';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #5DADE2;
      font-size: 1rem;
    }
    
    .cyrillic-main::before {
      left: -30px;
    }
    
    .cyrillic-main::after {
      right: -30px;
    }
    
    .cyrillic-sub {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.1rem;
      color: #85C1E9;
      font-weight: 700;
      letter-spacing: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      font-style: italic;
    }
    
    /* Soviet-style header */
    h1 {
      text-align: center;
      color: #D5DBDB;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 3.5rem;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-shadow: 
        0 0 8px rgba(213, 219, 219, 0.3),
        2px 2px 4px rgba(0, 0, 0, 0.6);
      position: relative;
    }
    
    h1::after {
      content: '★';
      position: absolute;
      right: -40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.6em;
      color: #5DADE2;
      animation: pulse 2s infinite;
    }
    
    h1::before {
      content: '★';
      position: absolute;
      left: -40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.6em;
      color: #5DADE2;
      animation: pulse 2s infinite 1s;
    }
    
    @keyframes pulse {
      0%, 100% { transform: translateY(-50%) scale(1); opacity: 1; }
      50% { transform: translateY(-50%) scale(1.2); opacity: 0.7; }
    }
    
    p.prompt {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      font-size: 1rem;
      color: #F8F9FA;
      margin-bottom: 2rem;
      text-align: center;
      line-height: 1.6;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
      border-left: 3px solid #AED6F1;
      padding-left: 1rem;
      background: rgba(0, 0, 0, 0.15);
      padding: 1rem;
      border-radius: 0;
      font-weight: 400;
    }
    
    .step-counter {
      text-align: center;
      color: #AED6F1;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    label {
      display: block;
      margin-top: 1.5rem;
      font-weight: 700;
      color: #D5DBDB;
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      border-bottom: 2px solid rgba(174, 214, 241, 0.3);
      padding-bottom: 0.5rem;
    }
    
    select {
      width: 100%;
      height: 50px;
      margin-top: 1rem;
      padding: 0.75rem;
      font-family: 'Roboto Condensed', sans-serif;
      border: 2px solid #85C1E9;
      border-radius: 0;
      background: linear-gradient(135deg, rgba(52, 73, 94, 0.9), rgba(93, 109, 126, 0.9));
      color: #F8F9FA;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
    }
    
    select:focus {
      outline: none;
      border-color: #AED6F1;
      box-shadow: 0 0 15px rgba(174, 214, 241, 0.4);
      background: linear-gradient(135deg, rgba(93, 109, 126, 0.9), rgba(52, 73, 94, 0.9));
    }
    
    select option {
      background: #34495E;
      color: #F8F9FA;
      padding: 0.5rem;
    }
    
    textarea {
      width: 100%;
      height: 100px;
      margin-top: 1rem;
      padding: 0.75rem;
      font-family: 'Roboto Condensed', sans-serif;
      border: 2px solid #85C1E9;
      border-radius: 0;
      background: linear-gradient(135deg, rgba(52, 73, 94, 0.8), rgba(93, 109, 126, 0.8));
      color: #F8F9FA;
      font-size: 1rem;
      font-weight: 400;
      resize: vertical;
      transition: all 0.3s ease;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
    }
    
    textarea:focus {
      outline: none;
      border-color: #AED6F1;
      box-shadow: 0 0 15px rgba(174, 214, 241, 0.4);
      background: linear-gradient(135deg, rgba(93, 109, 126, 0.8), rgba(52, 73, 94, 0.8));
    }
    
    textarea::placeholder {
      color: rgba(248, 249, 250, 0.6);
      font-style: italic;
    }
    
    .char-counter {
      text-align: right;
      font-size: 0.9rem;
      color: #AED6F1;
      margin-top: 0.5rem;
      font-weight: 700;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
    }
    
    .button-container {
      margin-top: 2.5rem;
      display: flex;
      gap: 1rem;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    button {
      padding: 1rem 2rem;
      border: 2px solid #85C1E9;
      border-radius: 0;
      cursor: pointer;
      font-size: 1.1rem;
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 
        0 4px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(174, 214, 241, 0.2);
      transition: all 0.3s ease;
      min-width: 120px;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #5DADE2, #85C1E9);
      color: #2C3E50;
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #85C1E9, #AED6F1);
      box-shadow: 
        0 6px 12px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(174, 214, 241, 0.3);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.8), rgba(93, 109, 126, 0.8));
      color: #F8F9FA;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, rgba(93, 109, 126, 0.8), rgba(133, 147, 158, 0.8));
      box-shadow: 
        0 6px 12px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(174, 214, 241, 0.2);
      transform: translateY(-2px);
    }
    
    .confirmation {
      display: none;
      text-align: center;
      color: #AED6F1;
      margin-top: 2rem;
      animation: fadeIn 0.5s ease-in;
    }
    
    .confirmation h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      color: #D5DBDB;
    }
    
    .confirmation p {
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      color: #F8F9FA;
    }
    
    .step {
      display: none;
      animation: slideIn 0.4s ease-in;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .reward-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #2C3E50 0%, #34495E 50%, #5D6D7E 100%);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 1s ease-in;
    }
    
    .reward-content {
      text-align: center;
      background: rgba(52, 73, 94, 0.95);
      padding: 3rem;
      border: 2px solid #AED6F1;
      box-shadow: 0 0 30px rgba(174, 214, 241, 0.3);
      max-width: 600px;
      width: 90%;
    }
    
    .reward-content h1 {
      color: #D5DBDB;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 3rem;
      margin-bottom: 2rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    
    .cute-animal {
      width: 100%;
      height: 300px;
      margin: 2rem 0;
      background: #85C1E9;
      border: 3px solid #AED6F1;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 4rem;
      border-radius: 10px;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
    }
    
    .reward-message {
      color: #F8F9FA;
      font-size: 1.5rem;
      margin: 1rem 0;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .reward-sub {
      color: #AED6F1;
      font-size: 1.1rem;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    @media (max-width: 600px) {
      .reward-content {
        padding: 2rem;
      }

      function showRewardPage() {
        console.log('showRewardPage() function called!');
        try {
          // Hide form and confirmation
          const form = document.getElementById('reflectionForm');
          const confirmation = document.getElementById('confirmation');
          const rewardPage = document.getElementById('rewardPage');
          const cuteAnimal = document.getElementById('cuteAnimal');
          
          console.log('Elements found:', { form: !!form, confirmation: !!confirmation, rewardPage: !!rewardPage, cuteAnimal: !!cuteAnimal });
          
          if (form) form.style.display = 'none';
          if (confirmation) confirmation.style.display = 'none';
          if (rewardPage) rewardPage.style.display = 'flex';
          
          console.log('Reward page should now be visible');
          
          // Array of cute animal emojis and messages
          const cuteAnimals = [
            { emoji: '🐕', message: 'Good boy! You completed the debrief!' },
            { emoji: '🐱', message: 'Purrfect! You\'re all done!' },
            { emoji: '🐰', message: 'Some-bunny appreciates your feedback!' },
            { emoji: '🐻', message: 'Bear-y good job on the debrief!' },
            { emoji: '🐨', message: 'Koala-ty feedback submitted!' },
            { emoji: '🦊', message: 'Fox-tastic work completing that!' },
            { emoji: '🐼', message: 'Panda-stic effort on the debrief!' },
            { emoji: '🐸', message: 'Toad-ally awesome job!' },
            { emoji: '🐹', message: 'Ham-some work on the feedback!' },
            { emoji: '🐧', message: 'Ice to meet a team player like you!' }
          ];
          
          // Pick a random animal
          const randomAnimal = cuteAnimals[Math.floor(Math.random() * cuteAnimals.length)];
          console.log('Selected animal:', randomAnimal);
          
          if (cuteAnimal) {
            cuteAnimal.innerHTML = `
              <div style="font-size: 6rem; margin-bottom: 1rem;">${randomAnimal.emoji}</div>
              <div style="font-size: 1.2rem; color: #2C3E50; font-weight: bold; text-shadow: none;">${randomAnimal.message}</div>
            `;
            console.log('Animal content set');
          }
          
          // Add back button functionality
          const backBtn = document.getElementById('backToFormBtn');
          if (backBtn) {
            backBtn.addEventListener('click', () => {
              location.reload(); // Simple way to reset the form
            });
          }
        } catch (error) {
          console.error('Reward page error:', error);
        }
      }
      
      .reward-content h1 {
        font-size: 2.5rem;
      }
      
      .cute-animal {
        height: 200px;
        font-size: 3rem;
      }
    }
      .container {
        padding: 1.5rem;
        margin: 0.5rem;
      }
      
      h1 {
        font-size: 2.5rem;
        letter-spacing: 2px;
      }
      
      h1::before,
      h1::after {
        display: none;
      }
      
      .button-container {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Soviet-style geometric background shapes -->
  <div class="bg-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
    <div class="shape shape-4"></div>
  </div>

  <div class="overlay">
    <div class="container">
      <!-- Cyrillic Graphics -->
      <div class="cyrillic-text">
        <div class="cyrillic-main">ПОЧАСОВОЙ ЖУРНАЛ</div>
        <div class="cyrillic-sub">СПИКИЗИ</div>
      </div>
      
      <h1>Debrief</h1>
      <p class="prompt">
        Feel free to answer any or all of these questions. Answers will help us to identify and address service issues.<br>
        <strong>Note:</strong> If you have an issue or concern that is more severe than this form allows for PLEASE bring it to someone you trust.
      </p>
      
      <div class="step-counter" id="stepCounter">Question 1 of 4</div>
      
      <form id="reflectionForm" role="form">
        <div class="step active" id="step-1" role="tabpanel" aria-labelledby="step-1-label">
          <label for="q1-category" id="step-1-label">1. What's one thing that went really well tonight?</label>
          <select id="q1-category" aria-describedby="q1-help">
            <option value="">-- Select a category --</option>
            <option value="Food">Food</option>
            <option value="Guest interaction">Guest interaction</option>
            <option value="Teamwork">Teamwork</option>
            <option value="Timing">Timing</option>
            <option value="Other">Other</option>
          </select>
          <textarea id="q1" maxlength="250" placeholder="Want to elaborate? Drop a note here." aria-describedby="q1-counter"></textarea>
          <div class="char-counter" id="q1-counter">0/250 characters</div>
        </div>

        <div class="step" id="step-2" role="tabpanel" aria-labelledby="step-2-label">
          <label for="q2-category" id="step-2-label">2. Care to highlight a moment of support that stood out tonight?</label>
          <select id="q2-category" aria-describedby="q2-help">
            <option value="">-- Select a support moment type --</option>
            <option value="Server to Server">Server to Server</option>
            <option value="Server to Runner">Server to Runner</option>
            <option value="Runner to Host">Runner to Host</option>
            <option value="Host to Server">Host to Server</option>
            <option value="Whole Team">Whole Team</option>
            <option value="Guest to Team">Guest to Team</option>
            <option value="Other / Not Sure">Other / Not Sure</option>
          </select>
          <textarea id="q2" maxlength="250" placeholder="What happened and who was involved?" aria-describedby="q2-counter"></textarea>
          <div class="char-counter" id="q2-counter">0/250 characters</div>
        </div>

        <div class="step" id="step-3" role="tabpanel" aria-labelledby="step-3-label">
          <label for="q3-category" id="step-3-label">3. Was there something that could have gone more smoothly tonight?</label>
          <select id="q3-category" aria-describedby="q3-help">
            <option value="">-- What area was this about? --</option>
            <option value="Timing">Timing</option>
            <option value="Guest experience">Guest experience</option>
            <option value="Communication">Communication</option>
            <option value="Turns">Turns</option>
            <option value="Other">Other</option>
          </select>
          <textarea id="q3" maxlength="250" placeholder="Want to share more details?" aria-describedby="q3-counter"></textarea>
          <div class="char-counter" id="q3-counter">0/250 characters</div>
        </div>

        <div class="step" id="step-4" role="tabpanel" aria-labelledby="step-4-label">
          <label for="q4-category" id="step-4-label">4. Any thoughts on what we could tweak to make things smoother?</label>
          <select id="q4-category" aria-describedby="q4-help">
            <option value="">-- What area does this relate to? --</option>
            <option value="Communication">Communication</option>
            <option value="Timing">Timing</option>
            <option value="Turns">Turns</option>
            <option value="Team support">Team support</option>
            <option value="Guest experience">Guest experience</option>
            <option value="Other">Other</option>
          </select>
          <textarea id="q4" maxlength="250" placeholder="Even a small idea can help!" aria-describedby="q4-counter"></textarea>
          <div class="char-counter" id="q4-counter">0/250 characters</div>
        </div>

        <div class="button-container" id="navigationButtons">
          <button type="button" id="backBtn" class="btn-secondary" style="display: none;">← Back</button>
          <div style="display: flex; gap: 1rem;">
            <button type="button" id="skipBtn" class="btn-secondary">Skip</button>
            <button type="button" id="nextBtn" class="btn-primary">Next →</button>
          </div>
        </div>
        
        <!-- Separate final step buttons -->
        <div class="button-container" id="finalButtons" style="display: none;">
          <button type="button" id="backBtn4" class="btn-secondary">← Back</button>
          <button type="button" id="skipSubmitBtn" class="btn-primary">Skip/Submit</button>
        </div>
      </form>
      
      <div class="confirmation" id="confirmation">
        <h2>Thanks for reflecting! 🌟</h2>
        <p>Your feedback helps make our team stronger.</p>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 1rem; font-style: italic;">please hold for pic of cute animal</p>
      </div>
      
      <!-- Reward Page -->
      <div class="reward-page" id="rewardPage" style="display: none;">
        <div class="reward-content">
          <h1>🎉 You Did It! 🎉</h1>
          <div class="cute-animal" id="cuteAnimal">
            <!-- Random cute animal will be displayed here -->
          </div>
          <p class="reward-message">Thanks for taking the time to debrief!</p>
          <p class="reward-sub">Your shift is officially complete. Rest well! 😴</p>
          <button type="button" id="backToFormBtn" class="btn-secondary" style="margin-top: 2rem;">Back to Form</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Add error handling to catch issues
    window.addEventListener('error', function(e) {
      console.error('Script Error Details:');
      console.error('Message:', e.message);
      console.error('Filename:', e.filename);
      console.error('Line:', e.lineno);
      console.error('Column:', e.colno);
      console.error('Error object:', e.error);
    });

    // Temporarily disable service worker to test
    /*
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
            // Don't let SW errors break the app
          });
      });
    }
    */

    document.addEventListener('DOMContentLoaded', function () {
      try {
      const steps = document.querySelectorAll('.step');
      const nextBtn = document.getElementById('nextBtn');
      const skipBtn = document.getElementById('skipBtn');
      const backBtn = document.getElementById('backBtn');
      const stepCounter = document.getElementById('stepCounter');
      const navigationButtons = document.getElementById('navigationButtons');
      const confirmation = document.getElementById('confirmation');
      const form = document.getElementById('reflectionForm');
      
      let currentStep = 0;

      // Initialize character counters
      function initCharCounters() {
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
          const counterId = textarea.id + '-counter';
          const counter = document.getElementById(counterId);
          
          function updateCounter() {
            const remaining = textarea.value.length;
            const max = textarea.maxLength;
            counter.textContent = `${remaining}/${max} characters`;
            
            if (remaining > max * 0.9) {
              counter.style.color = '#5DADE2';
            } else {
              counter.style.color = '#AED6F1';
            }
          }
          
          textarea.addEventListener('input', updateCounter);
          updateCounter();
        });
      }

      function showStep(index) {
        // Remove active class from all steps
        steps.forEach(step => step.classList.remove('active'));
        
        // Add active class to current step
        if (steps[index]) {
          steps[index].classList.add('active');
        }
        
        // Update step counter
        stepCounter.textContent = `Question ${index + 1} of ${steps.length}`;
        
        // Update navigation
        updateNavigation();
      }

      function updateNavigation() {
        const buttonContainer = document.querySelector('.button-container');
        if (!buttonContainer) {
          console.error('Button container not found');
          return;
        }
        
        try {
          if (currentStep === steps.length - 1) {
            // Final step: only show Back and Skip/Submit
            buttonContainer.innerHTML = `
              <button type="button" id="backBtn4" class="btn-secondary">← Back</button>
              <button type="button" id="skipSubmitBtn" class="btn-primary">Skip/Submit</button>
            `;
            
            // Re-attach event listeners for final step
            const backBtn4 = document.getElementById('backBtn4');
            const skipSubmitBtn = document.getElementById('skipSubmitBtn');
            
            if (backBtn4) {
              backBtn4.addEventListener('click', () => {
                currentStep--;
                showStep(currentStep);
              });
            }
            
            if (skipSubmitBtn) {
              skipSubmitBtn.addEventListener('click', submitForm);
            }
          } else {
            // Regular navigation
            buttonContainer.innerHTML = `
              <button type="button" id="backBtn" class="btn-secondary" style="display: ${currentStep > 0 ? 'inline-block' : 'none'};">← Back</button>
              <div style="display: flex; gap: 1rem;">
                <button type="button" id="skipBtn" class="btn-secondary">Skip</button>
                <button type="button" id="nextBtn" class="btn-primary">Next →</button>
              </div>
            `;
            
            // Re-attach event listeners for regular steps
            const nextBtn = document.getElementById('nextBtn');
            const skipBtn = document.getElementById('skipBtn');
            const backBtn = document.getElementById('backBtn');
            
            if (nextBtn) {
              nextBtn.addEventListener('click', () => {
                currentStep++;
                showStep(currentStep);
              });
            }
            
            if (skipBtn) {
              skipBtn.addEventListener('click', () => {
                currentStep++;
                showStep(currentStep);
              });
            }
            
            if (backBtn) {
              backBtn.addEventListener('click', () => {
                currentStep--;
                showStep(currentStep);
              });
            }
          }
        } catch (error) {
          console.error('Navigation update error:', error);
        }
      }

      function submitForm() {
        // Hide form and show confirmation
        form.style.display = 'none';
        confirmation.style.display = 'block';
        
        // Show reward page instead of external redirect
        console.log('About to show reward page in 2.5 seconds...');
        setTimeout(() => {
          console.log('Timeout fired, calling showRewardPage()');
          showRewardPage();
        }, 2500);
      }

      // Event listeners - will be dynamically attached in updateNavigation()
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        try {
          if (e.key === 'Enter' && e.ctrlKey) {
            const nextBtn = document.getElementById('nextBtn');
            const skipSubmitBtn = document.getElementById('skipSubmitBtn');
            if (currentStep === steps.length - 1 && skipSubmitBtn) {
              skipSubmitBtn.click();
            } else if (nextBtn) {
              nextBtn.click();
            }
          } else if (e.key === 'ArrowLeft' && e.altKey && currentStep > 0) {
            const backBtn = currentStep === steps.length - 1 
              ? document.getElementById('backBtn4')
              : document.getElementById('backBtn');
            if (backBtn) backBtn.click();
          } else if (e.key === 'ArrowRight' && e.altKey && currentStep < steps.length - 1) {
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) nextBtn.click();
          }
        } catch (error) {
          console.error('Keyboard navigation error:', error);
        }
      });

      // Initialize the form
      initCharCounters();
      showStep(currentStep);
      
      } catch (error) {
        console.error('Initialization error:', error);
        // Fallback: at least show the first step
        const firstStep = document.getElementById('step-1');
        if (firstStep) {
          firstStep.style.display = 'block';
        }
      }
    });
  </script>
</body>
</html>